name: Deploy to Azure VM

on:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install SSHpass
      run: sudo apt-get update && sudo apt-get install -y sshpass

    - name: Deploy to Azure VM
      run: |
        # Transfer the entire project to the server
        echo "ğŸ“¤ Uploading code to Azure VM..."
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" scp -o StrictHostKeyChecking=no -r ./* azureuser@74.161.33.87:/home/azureuser/RecommendationSystemApp/
        
        # Execute deployment commands
        echo "ğŸš€ Starting deployment..."
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no azureuser@74.161.33.87 "
          set -e
          cd /home/azureuser/RecommendationSystemApp
          
          echo 'ğŸ›‘ Stopping existing containers...'
          docker-compose down || true
          
          echo 'ğŸ³ Building new containers...'
          docker-compose build --pull
          
          echo 'ğŸš€ Starting containers...'
          docker-compose up -d
          
          echo 'ğŸ§¹ Cleaning up unused images...'
          docker image prune -f
          
          echo 'âœ… Deployment completed successfully!'
        "

    - name: Verify deployment
      run: |
        echo "ğŸ” Checking deployment status..."
        sshpass -p "${{ secrets.SERVER_PASSWORD }}" ssh -o StrictHostKeyChecking=no azureuser@74.161.33.87 "
          cd /home/azureuser/RecommendationSystemApp
          echo 'ğŸ“Š Container status:'
          docker-compose ps
          echo ''
          echo 'ğŸ” Recent logs:'
          docker-compose logs --tail=20
        "
